<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<dom-module id="welcome-web">
    <template>
        <!--<style include="jso-styles">-->
        <style>
            .welcome-center {
                margin: auto;
                width: 80%;
                text-align: justify;
                font-size: 18px;
                color: #797979;
            }

            .welcome-center > p,
            .welcome-center > ul {
                font-size: .8em;
                line-height: 1.4em;
            }

            .hi-icon-wrap {
                text-align: center;
                margin: 0 auto;
                padding: 2em 0 3em;
            }

            .hi-icon {
                display: inline-block;
                cursor: pointer;
                margin: 15px 30px;
                width: 110px;
                height: 110px;
                border-radius: 50%;
                text-align: center;
                position: relative;
                z-index: 1;
            }

            .hi-icon a p {
                text-decoration: none;
                color: #000966;
            }

            .hi-icon a:hover p {
                text-decoration: none;
            }

            .hi-icon:after {
                pointer-events: none;
                position: absolute;
                width: 100%;
                height: 100%;
                border-radius: 50%;
                content: '';
                -webkit-box-sizing: content-box;
                -moz-box-sizing: content-box;
                box-sizing: content-box;
            }

            .hi-icon:before {
                /*font-family: 'ecoicon';*/
                speak: none;
                font-size: 48px;
                line-height: 110px;
                font-style: normal;
                font-variant: normal;
                text-transform: none;
                display: block;
                -webkit-font-smoothing: antialiased;
                color: #000966;
            }

            .hi-icon-mobile:before {
                content: "\e009";
            }

            .hi-icon-animation .hi-icon {
                -webkit-transition: box-shadow 0.2s;
                -moz-transition: box-shadow 0.2s;
                transition: box-shadow 0.2s;
            }

            .hi-icon-animation p {
                -webkit-transition: all 0.3s;
                -moz-transition: all 0.3s;
                transition: all 0.3s;
                color: #797979;
            }

            .hi-icon-animation .hi-icon svg {
                -webkit-transition: -webkit-transform 0.2s, all 0.2s;
                -moz-transition: -moz-transform 0.2s, all 0.2s;
                transition: transform 0.2s, all 0.2s;
                fill: #000966;
                height: 90px;
                width: 90px;
            }

            .hi-icon-animation .hi-icon.fa {
                -webkit-transition: -webkit-transform 0.2s, all 0.2s;
                -moz-transition: -moz-transform 0.2s, all 0.2s;
                transition: transform 0.2s, all 0.2s;
            }

            .hi-icon-animation .hi-icon svg image {
                height: 90px;
                width: 90px;
            }

            .hi-icon-animation .hi-icon:after {
                top: 0;
                left: 0;
                padding: 0;
                box-shadow: 0 0 0 4px #000966;
                -webkit-transition: -webkit-transform 0.2s, opacity 0.2s;
                -moz-transition: -moz-transform 0.2s, opacity 0.2s;
                transition: transform 0.2s, opacity 0.2s;
            }

            .hi-icon-animation .icon-wrapper:hover {
                display: inline-block;
                text-decoration: none;
            }

            .hi-icon-animation .icon-wrapper:hover .hi-icon:after {
                -webkit-transform: scale(0.85);
                -moz-transform: scale(0.85);
                -ms-transform: scale(0.85);
                transform: scale(0.85);
                opacity: 0.5;
            }

            /* in case of svg icon*/
            .hi-icon-animation .icon-wrapper:hover .hi-icon svg {
                transform: scale(0.85);
            }

            /* in case of fa icon*/
            .hi-icon-animation .icon-wrapper:hover .hi-icon.fa {
                transform: scale(0.85);
            }

            .hi-icon-animation .icon-wrapper:hover .hi-icon {
                box-shadow: 0 0 0 10px rgba(0, 9, 102, 1);
                color: #fff;
            }

            .hi-icon-animation .icon-wrapper:hover p {
                color: #000966;
            }

            .smaller {
                font-size: 75%;
            }

            .getting-started {
                display: inline-block;
                border: 4px #000966 solid;
                background: white;
                position: relative;
                padding: 10px 35px;
                -webkit-transition: all 0.3s;
                -moz-transition: all 0.3s;
                transition: all 0.3s;
                border-radius: 30px;
            }

            .getting-started:hover {
                text-decoration: none;
            }

            .getting-started span {
                color: #000966;
                font-size: .8em;
                display: inline-block;
                -webkit-transition: all 0.3s;
                -moz-transition: all 0.3s;
                transition: all 0.3s;
            }

            .getting-started:hover {
                -webkit-transform: scale(1.2);
                -moz-transform: scale(1.2);
                -ms-transform: scale(1.2);
                transform: scale(1.2);
                border: 4px #fff solid;
                background: #000966;
            }

            .getting-started:hover span {
                -webkit-transform: scale(.8);
                -moz-transform: scale(.8);
                -ms-transform: scale(.8);
                transform: scale(.8);
                color: #fff
            }

            #title {
                font-size: 8em;
                text-align: center;
                font-weight: bold;
                letter-spacing: -20px;
                position: relative;
            }

            #title::first-letter {
                letter-spacing: -5px;
            }

            #title span.subtitle {
                font-size: 25px;
                margin-top: -30px;
                display: block;
                letter-spacing: 0;
            }

            #title .version {
                font-size: 15px;
                display: inline-block;
                vertical-align: top;
                letter-spacing: 0px;
                margin: 35px 0 0 0;
                position: absolute;
            }

            #title .bracket {
                font-size: 1.5em;
                color: black;
            }

            .footer {
                margin-bottom: 80px;
            }
        </style>

        <!-- This is where main application is rendered -->
        <div class="welcome-center">
            <h1 id="title">IVA
                <p class="version">
                    <span class="bracket">(</span>Pre-Release<span class="bracket">)</span>
                </p>
                <span class="subtitle">Interactive Variant Analysis</span>
            </h1>

            <p>
                Please be aware that this is a pre-release version of IVA.
            </p>

            <p>
                The Interactive Variant Analysis tool (IVA) enables whole-genome variant browsing and analysis. Query across cohorts to find variants that segregate in family pedigrees, between cases and controls, or in sporadic samples. Utilise a range of filters; including population frequency, consequence type, mode of inheritance and phenotype associations. IVA and OpenCGA are part of the <a href="https://github.com/opencb" target="_blank">OpenCB</a> Project.
            </p>

            <p>
                The OpenCGA database currently holds all interpreted genomes that are available from the 100,000 Genomes
                Project from Genomics England. These are divided into the following studies: GRCh37 rare disease (RD37),
                GRCh38 rare disease (RD38), cancer germline GRCh38 (CG38), and cancer somatic GRCh38 (CS38).
            </p>

            <p>
                We are very keen to get user's feedback on IVA including:
            </p>
            <ul>
                <li>how IVA facilitates your research</li>
                <li>how excited you are about the additional functionality IVA brings</li>
                <li>additional functions or changes to IVA you would like us to consider</li>
                <li>any bugs or issues encountered when using IVA</li>
                <li>whether you think IVA will expand the utility of the research environment to a new user base</li>
            </ul>

            <template is="dom-if" if="{{checkProjects}}">
                <div style="padding: 20px 10px">
                    <h3>Quick Search</h3>
                    <input id="welcomeSearchTextBox" type="text" class="form-control input-lg" list="FeatureDatalist"
                           on-keyup="callAutocomplete"
                           placeholder="Search for gene symbols, genomic regions or variants" value="">
                    <datalist id="FeatureDatalist"></datalist>
                    <!-- Examples -->
                    <span style="font-size: 0.8em; padding-left: 10px">
                        Examples - Gene: <a on-click="onExampleClick" data-type="gene" style="cursor: pointer">BRCA2</a>,
                        Region: <a on-click="onExampleClick" data-type="region" style="cursor: pointer">3</a>, <a
                            on-click="onExampleClick" data-type="region" style="cursor: pointer">3:113000-1150000</a>,
                        SNP: <a on-click="onExampleClick" data-type="snp" style="cursor: pointer">rs445909</a>
                        Variant: <a on-click="onExampleClick" data-type="variant" style="cursor: pointer">13:32962274:G:T</a>
                    </span>
                </div>
            </template>
            <br>

            <div class="row hi-icon-wrap hi-icon-effect-9 hi-icon-animation">
                <template is="dom-repeat" items={{components}} as="tool">
                    <div class="col-md-3 col-sm-6">
                        <template is="dom-if" if="{{checkProjects}}">
                            <a class="icon-wrapper"
                               href$="#{{tool.id}}/{{opencgaSession.project.id}}/{{opencgaSession.study.id}}">
                                <div class$="hi-icon {{tool.fa_icon}}">
                                </div>
                                <p>{{tool.title}}</p>
                                <span class="smaller"></span>
                            </a>
                        </template>
                        <template is="dom-if" if="{{!checkProjects}}">
                            <a class="icon-wrapper" href$="#{{tool.id}}">
                                <div class$="hi-icon {{tool.fa_icon}}">
                                </div>
                                <p>{{tool.title}}</p>
                                <span class="smaller"></span>
                            </a>
                        </template>

                    </div>
                </template>
            </div>

            <div class="row text-center">
                <a class="getting-started" href="#gettingstarted"><span>Getting started with IVA</span></a>
            </div>

            <div class="footer">
                <hr >
                Please send your feedback to <a href="mailto:gecip-help@genomicsengland.co.uk">gecip-help@genomicsengland.co.uk</a>
                with 'IVA feedback' as the subject.
            </div>
            <!--<h4>Note:</h4>
            <p style="font-size:14px">
                IVA web application makes an intensive use of the HTML5 standard and other cutting-edge web technologies
                such as Web Components,
                so only modern web browsers are fully supported, these include Chrome 49+, Firefox 45+, Microsoft Edge
                14+, Safari 10+ and Opera 36+.
            </p>
            <br>
            <br>-->
        </div>
    </template>

    <script>

        class Welcome extends Polymer.Element {

            constructor() {
                super();

                this.checkProjects = false;
            }

            static get is() {
                return "welcome-web";
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object,
                        observer: "opencgaSessionObserver"
                    },
                    version: {
                        type: String
                    },
                    cellbaseClient: {
                        type: Object
                    },
                    config: {
                        type: Object
                    }
                }
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }


            // onBlur(e) {
            //     this.notify();
            // }

            // onKeyup(e) {
            //     if (e.keyCode === 13) {
            //         this.notify();
            //     }
            // }

            connectedCallback() {
                super.connectedCallback();
                this.components = this.config.components.filter(this.isVisible).slice(0, 4);
            }

            opencgaSessionObserver() {
                if (UtilsNew.isNotUndefinedOrNull(this.opencgaSession) && UtilsNew.isNotUndefinedOrNull(this.opencgaSession.project)) {
                    this.checkProjects = true;
                } else {
                    this.checkProjects = false;
                }
            }

            onExampleClick(e) {
                let query = {study: this.opencgaSession.study.fqn};
                switch (e.currentTarget.dataset.type) {
                case "gene":
                    query.gene = e.currentTarget.text;
                    break;
                case "region":
                    query.region = e.currentTarget.text;
                    break;
                case "snp":
                    query.xref = e.currentTarget.text;
                    break;
                case "variant":
                    query.xref = e.currentTarget.text;
                    break;
                }
                this.notify(query);
            }

            notify(query) {
                query.study = this.opencgaSession.study.fqn;
                this.dispatchEvent(new CustomEvent("search", {
                    detail: query,
                    bubbles: true,
                    composed: true
                }));
            }

            callAutocomplete(e) {
                // Only gene symbols are going to be searched and not Ensembl IDs
                let featureId = PolymerUtils.getElementById("welcomeSearchTextBox").value;
                if (UtilsNew.isNotEmpty(featureId)) {
                    let query = {};
                    if (featureId.startsWith("chr") || featureId.startsWith("X") || featureId.startsWith("Y") || featureId.startsWith("MT") || featureId.match(/^\d/)) {
                        if (featureId.split(":").length < 3) {
                            // It's a region, contains only one ':' character
                            query.region = featureId;
                        } else {
                            query.xref = featureId;
                        }
                    } else if (featureId.startsWith("rs")) {
                        query.xref = featureId;
                    } else {
                        // The ID written seems to be a gene name
                        query.gene = featureId;
                        if (featureId.length >= 3 && !featureId.startsWith("ENS")) {
                            let _this = this;
                            _this.cellbaseClient.get("feature", "id", featureId.toUpperCase(), "starts_with", {}, {})
                                .then(function (response) {
                                    let options = "";
                                    for (let id of response.response[0].result) {
                                        options += `<option value="${id.name}">`;
                                    }
                                    PolymerUtils.innerHTML("FeatureDatalist", options);
                                });
                        }
                    }

                    if (e.keyCode === 13) {
                        this.notify(query);
                        PolymerUtils.getElementById("welcomeSearchTextBox").value = "";
                    }

                } else {
                    PolymerUtils.innerHTML("FeatureDatalist", "");
                }
            }

            changeTool(e) {
                this.dispatchEvent(new CustomEvent("changetool", {
                    detail: e.target,
                    bubbles: true,
                    composed: true
                }));
            }

            isVisible(item) {
                switch (item.visibility) {
                case "public":
                    return true;
                case "private":
                    return UtilsNew.isNotUndefinedOrNull(this.opencgaSession) && UtilsNew.isNotEmpty(this.opencgaSession.token);
                case "none":
                default:
                    return false;
                }
            }
        }

        customElements.define(Welcome.is, Welcome);
    </script>
</dom-module>
